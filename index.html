<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Deutschunterricht-Tools</title>
  <style>
    :root { --bg:#0b1020; --card:#131a33; --muted:#94a3b8; --text:#e5e7eb; --ok:#16a34a; --bad:#dc2626; --accent:#4f46e5; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif; background:linear-gradient(180deg,#0b1020,#0b1226 40%,#0c132a); color:var(--text); }
    .wrap { max-width:1180px; margin:24px auto; padding:0 16px 48px; }
    h1 { font-size:clamp(20px,4vw,34px); font-weight:800; margin-bottom:20px; }
    nav { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px; }
    nav button { padding:10px 16px; border-radius:10px; border:1px solid rgba(255,255,255,0.14); background:#0f1736; color:var(--text); cursor:pointer; font-weight:700; }
    nav button.active { background:linear-gradient(180deg,#4f46e5,#4338ca); border-color:#6366f1; }
    .tool { display:none; }
    .tool.active { display:block; }
    .card { background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); border-radius:16px; padding:18px; margin-bottom:20px; box-shadow:0 6px 30px rgba(0,0,0,0.2); }
    input, textarea, select { width:100%; padding:12px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.12); background:#0e1530; color:var(--text); }
    textarea{ min-height:140px; font-family:ui-monospace,Menlo,Consolas,monospace; font-size:14px; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,0.14); background:#0f1736; color:var(--text); cursor:pointer; font-weight:700; margin:5px; }
    .btn.primary{ background:linear-gradient(180deg,#4f46e5,#4338ca); border-color:#6366f1; }
    .ok{ color:var(--ok); }
    .bad{ color:var(--bad); }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .grid{display:grid;gap:12px}
    .grid2{grid-template-columns:1fr 1fr}
    .grid3{grid-template-columns:repeat(3,1fr)}
    @media(min-width:980px){.grid2{display:grid}.grid3{display:grid}}
    .muted{color:var(--muted)}
    .small{font-size:12px;color:var(--muted)}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid rgba(255,255,255,0.08);padding:8px 6px;text-align:left;font-size:14px}
    .hint{background:#0e1634;border:1px dashed rgba(255,255,255,0.12);padding:8px 10px;border-radius:10px}
    .pill{padding:6px 10px;border-radius:999px;background:#0e1634;border:1px solid rgba(255,255,255,.12);font-size:12px;color:var(--muted)}
    .qbig{font-size:clamp(22px,4.2vw,30px);font-weight:900}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Deutschunterricht ‚Äì Digitale Tools</h1>
    <nav>
      <button data-tool="trainer" class="active">üß† Stammformen</button>
      <button data-tool="timer">‚è≤ Zeituhr</button>
      <button data-tool="stopwatch">‚è± Stoppuhr</button>
      <button data-tool="countdown">‚è≥ Countdown</button>
      <button data-tool="names">üé≤ Zufallsnamen</button>
      <button data-tool="cloze">üî° L√ºckentext</button>
      <button data-tool="satzglieder">üß© Satzglied‚ÄëTester</button>
      <button data-tool="dictation">‚úç Diktatgenerator</button>
      <button data-tool="textanalysis">üîç Text‚ÄëAnalyse</button>
    </nav>

    <!-- Stammformen-Trainer (Platzhalter f√ºr externe/√§ltere Einbettung) -->
    <div id="trainer" class="tool active">
      <div class="card">
        <h2>Stammformen‚ÄëTrainer</h2>
        <iframe srcdoc="PLACEHOLDER" style="width:100%;height:600px;border:none;border-radius:12px;"></iframe>
        <p class="small">Hinweis: Der Trainer l√§uft offline und speichert lokal. (Mehrere Sets, CSV‚ÄëExport, E‚ÄëMail‚ÄëVersand verf√ºgbar)</p>
      </div>
    </div>

    <!-- Zeituhr: Endzeit einstellbar / Anzeige -->
    <div id="timer" class="tool">
      <div class="card">
        <h2>Zeituhr</h2>
        <div class="grid grid3">
          <div>
            <label>Dauer (Minuten)</label>
            <input id="tm-mins" type="number" min="1" value="45" />
          </div>
          <div>
            <label>Endzeit (optional)</label>
            <input id="tm-end" type="time" />
          </div>
          <div style="display:flex;align-items:flex-end;gap:8px">
            <button class="btn primary" id="tm-start">Start</button>
            <button class="btn" id="tm-stop">Stopp</button>
            <button class="btn" id="tm-reset">Reset</button>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <span class="pill">Jetzt: <span id="tm-now">--:--:--</span></span>
          <span class="pill">Ende um: <span id="tm-endsAt">‚Äî</span></span>
        </div>
        <div id="tm-display" class="qbig" style="text-align:center;margin-top:10px">00:00</div>
      </div>
    </div>

    <!-- Stoppuhr: Lap‚ÄëNamen mit besserem Feld + nachtr√§glich editierbar -->
    <div id="stopwatch" class="tool">
      <div class="card">
        <h2>Stoppuhr</h2>
        <div class="qbig" id="swDisplay">00:00.000</div>
        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="swStart">Start</button>
          <button class="btn" id="swLap">Runde</button>
          <button class="btn" id="swStop">Stopp</button>
          <button class="btn" id="swReset">Reset</button>
        </div>
        <div class="row" style="margin-top:12px">
          <label style="min-width:160px">Runden‚ÄëName</label>
          <input id="swLapName" placeholder="z.‚ÄØB. Gruppe A ‚Äì Vorlesen" style="margin-top:4px"/>
        </div>
        <div style="margin-top:12px;max-height:260px;overflow:auto">
          <table class="table" id="swLaps"><thead><tr><th>#</th><th>Name (bearbeitbar)</th><th>Zeit</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>

    <!-- Countdown: Pause/Resume -->
    <div id="countdown" class="tool">
      <div class="card">
        <h2>Countdown</h2>
        <div class="grid grid3">
          <div><label>Minuten</label><input id="cd-min" type="number" min="0" value="5"/></div>
          <div><label>Sekunden</label><input id="cd-sec" type="number" min="0" max="59" value="0"/></div>
          <div style="display:flex;align-items:flex-end;gap:8px">
            <button class="btn primary" id="cd-start">Start</button>
            <button class="btn" id="cd-pause">Pause</button>
            <button class="btn" id="cd-resume">Weiter</button>
            <button class="btn" id="cd-reset">Reset</button>
          </div>
        </div>
        <div class="qbig" id="cd-display" style="text-align:center;margin-top:10px">05:00</div>
      </div>
    </div>

    <!-- Zufallsnamen & Gruppen: Verbots‚ÄëPaare + Alleinsitzer -->
    <div id="names" class="tool">
      <div class="card">
        <h2>Zufallsnamen & Gruppen</h2>
        <div class="grid grid2">
          <div>
            <label>Namen (eine Zeile pro Name)</label>
            <textarea id="nameList" placeholder="Anna\nBen\nElif\n‚Ä¶"></textarea>
            <div class="row" style="justify-content:flex-start;margin-top:8px">
              <button class="btn primary" id="ng-pick">Zufallsname</button>
              <button class="btn" id="ng-reset">Reset</button>
            </div>
            <div class="hint small" id="pickedName" style="margin-top:8px">‚Äî</div>
          </div>
          <div>
            <div class="grid grid2">
              <div>
                <label>Gruppengr√∂√üe</label>
                <input id="groupSize" type="number" min="1" value="3" />
              </div>
              <div>
                <label>Alleinsitzer (eine pro Zeile)</label>
                <textarea id="soloList" placeholder="Name1\nName2"></textarea>
              </div>
            </div>
            <label style="margin-top:8px">Konflikt‚ÄëPaare (Name1,Name2 pro Zeile)</label>
            <textarea id="avoidPairs" placeholder="Anna,Ben\nElif,Max"></textarea>
            <button class="btn" id="makeGroups">Gruppen bilden</button>
            <div id="groups" style="margin-top:8px"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- L√ºckentext (mit gr√∂√üerem Zeilenabstand im Druck) -->
    <div id="cloze" class="tool">
      <div class="card">
        <h2>L√ºckentext‚ÄëGenerator</h2>
        <div class="grid grid2">
          <div>
            <label>Ausgangstext</label>
            <textarea id="cz-input" placeholder="Text hier einf√ºgen‚Ä¶"></textarea>
            <div class="row" style="justify-content:flex-end;margin-top:8px">
              <label class="pill">Anteil (%) <input id="cz-pct" type="number" min="0" max="90" value="20" style="width:70px"></label>
              <label class="pill">min. Wortl√§nge <input id="cz-minlen" type="number" min="2" value="4" style="width:70px"></label>
              <button class="btn primary" id="cz-make">Erstellen</button>
              <button class="btn" id="cz-print">Drucken</button>
            </div>
          </div>
          <div>
            <div class="row" style="justify-content:space-between;align-items:center">
              <div style="font-weight:800">Arbeitsblatt</div>
              <button class="btn" id="cz-key">L√∂sung ein/aus</button>
            </div>
            <div id="cz-out" style="white-space:pre-wrap;margin-top:8px"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Satzglied‚ÄëTester (neues Format) -->
    <div id="satzglieder" class="tool">
      <div class="card">
        <h2>Satzglied‚ÄëTester</h2>
        <div class="grid grid2">
          <div>
            <label>Satzglieder ausw√§hlen</label>
            <div class="row">
              <label class="pill"><input type="checkbox" class="sg-tag" value="Subjekt" checked> Subjekt</label>
              <label class="pill"><input type="checkbox" class="sg-tag" value="Pr√§dikat" checked> Pr√§dikat</label>
              <label class="pill"><input type="checkbox" class="sg-tag" value="Objekt" checked> Objekt</label>
              <label class="pill"><input type="checkbox" class="sg-tag" value="Adverbiale"> Adverbiale</label>
              <label class="pill"><input type="checkbox" class="sg-tag" value="Pr√§p.-Objekt"> Pr√§p.-Objekt</label>
            </div>
            <label style="margin-top:8px">Aufgabens√§tze (Format: Segment~Label mit | trennen)</label>
            <textarea id="sg-input" placeholder="Wir~Subjekt|lesen~Pr√§dikat|heute den Text~Objekt\nMorgen~Adverbiale|kommt~Pr√§dikat|die Klasse~Subjekt"></textarea>
            <div class="row" style="justify-content:flex-end;margin-top:8px">
              <button class="btn" id="sg-start">Start</button>
            </div>
          </div>
          <div>
            <div id="sg-quiz"></div>
            <div id="sg-summary" style="display:none"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Diktatgenerator -->
    <div id="dictation" class="tool">
      <div class="card">
        <h2>Diktatgenerator</h2>
        <textarea id="dictInput" placeholder="Text f√ºr das Diktat hier einf√ºgen"></textarea>
        <div class="row" style="margin-top:8px">
          <button class="btn primary" id="dk-start">Starten</button>
          <button class="btn" id="dk-stop">Stopp</button>
        </div>
        <div id="dictationDisplay" class="small muted">Bereit</div>
      </div>
    </div>

    <!-- Text-Analyse erweitert -->
    <div id="textanalysis" class="tool">
      <div class="card">
        <h2>Text‚ÄëAnalyse</h2>
        <textarea id="analysisInput" placeholder="Text hier einf√ºgen"></textarea>
        <div class="row" style="justify-content:flex-end;margin-top:8px">
          <button class="btn primary" id="ta-run">Analysieren</button>
        </div>
        <div class="grid grid2">
          <div>
            <div>W√∂rter: <b id="ta-words">0</b> ¬∑ S√§tze: <b id="ta-sent">0</b> ¬∑ Zeichen (o. Leerz.): <b id="ta-chars">0</b></div>
            <div style="margin-top:6px">Objektivit√§ts‚ÄëIndikator: <b id="ta-objective">0%</b></div>
            <div style="margin-top:10px"><b>H√§ufigste W√∂rter</b><div id="ta-top" class="small muted"></div></div>
          </div>
          <div>
            <div><b>Direkte Rede ‚Äì S√§tze & Zeilen</b></div>
            <div id="ta-quotes" class="small"></div>
            <div style="margin-top:10px"><b>Umgangssprachlich / nicht neutral</b><div id="ta-colloq" class="small"></div></div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    // Navigation
    document.querySelectorAll('nav button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.tool').forEach(t=>t.classList.remove('active'));
        document.getElementById(btn.dataset.tool).classList.add('active');
      });
    });

    const pad=n=>String(n).padStart(2,'0');

    // ===== Zeituhr =====
    let tmTimer=null; let tmEndsAt=null;
    function updateNow(){ const d=new Date(); document.getElementById('tm-now').textContent = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; }
    setInterval(updateNow,500); updateNow();
    function tickTimer(){ if(tmEndsAt){ const now=new Date(); let rem=Math.max(0, Math.floor((tmEndsAt-now)/1000)); const m=Math.floor(rem/60), s=rem%60; document.getElementById('tm-display').textContent=`${pad(m)}:${pad(s)}`; if(rem<=0){ clearInterval(tmTimer); tmTimer=null; }
    } }
    document.getElementById('tm-start').onclick=()=>{
      clearInterval(tmTimer);
      const mins=parseInt(document.getElementById('tm-mins').value||'0',10);
      const customEnd=document.getElementById('tm-end').value; // HH:MM
      const now=new Date();
      if(customEnd){
        const [hh,mm]=customEnd.split(':').map(Number);
        tmEndsAt=new Date(now); tmEndsAt.setHours(hh,mm,0,0);
        if(tmEndsAt<now){ // falls Endzeit am n√§chsten Tag gemeint
          tmEndsAt.setDate(tmEndsAt.getDate()+1);
        }
      } else {
        tmEndsAt=new Date(now.getTime()+mins*60000);
      }
      document.getElementById('tm-endsAt').textContent=`${pad(tmEndsAt.getHours())}:${pad(tmEndsAt.getMinutes())}`;
      tmTimer=setInterval(tickTimer,250); tickTimer();
    };
    document.getElementById('tm-stop').onclick=()=>{ clearInterval(tmTimer); };
    document.getElementById('tm-reset').onclick=()=>{ clearInterval(tmTimer); tmEndsAt=null; document.getElementById('tm-display').textContent='00:00'; document.getElementById('tm-endsAt').textContent='‚Äî'; };

    // ===== Stoppuhr =====
    let swInterval, swStart=0, swElapsed=0, swRunning=false, swLap=0;
    function fmtMs(ms){ const m=Math.floor(ms/60000), s=Math.floor((ms%60000)/1000), t=ms%1000; return `${pad(m)}:${pad(s)}.${String(t).padStart(3,'0')}`; }
    function swTick(){ if(!swRunning) return; const ms=swElapsed + (Date.now()-swStart); document.getElementById('swDisplay').textContent=fmtMs(ms); }
    document.getElementById('swStart').onclick=()=>{ if(!swRunning){ swRunning=true; swStart=Date.now(); swInterval=setInterval(swTick,31); } else { swElapsed += Date.now()-swStart; swRunning=false; clearInterval(swInterval); } };
    document.getElementById('swStop').onclick=()=>{ if(swRunning){ swElapsed += Date.now()-swStart; swRunning=false; clearInterval(swInterval); } };
    document.getElementById('swReset').onclick=()=>{ swRunning=false; clearInterval(swInterval); swElapsed=0; swLap=0; document.getElementById('swDisplay').textContent='00:00.000'; document.querySelector('#swLaps tbody').innerHTML=''; };
    document.getElementById('swLap').onclick=()=>{ const ms=swRunning? (swElapsed + (Date.now()-swStart)) : swElapsed; const name=(document.getElementById('swLapName').value||'').trim(); const tr=document.createElement('tr'); tr.innerHTML=`<td>${++swLap}</td><td contenteditable="true">${name||'-'}</td><td>${fmtMs(ms)}</td>`; document.querySelector('#swLaps tbody').appendChild(tr); };

    // ===== Countdown =====
    let cdTimer=null, cdRemain=300, cdPaused=false;
    function cdRender(){ const m=Math.floor(cdRemain/60), s=cdRemain%60; document.getElementById('cd-display').textContent=`${pad(m)}:${pad(s)}`; }
    document.getElementById('cd-start').onclick=()=>{ const m=Math.max(0,parseInt(document.getElementById('cd-min').value||'0',10)); const s=Math.max(0,parseInt(document.getElementById('cd-sec').value||'0',10)); cdRemain=m*60+s; cdPaused=false; clearInterval(cdTimer); cdTimer=setInterval(()=>{ if(!cdPaused){ cdRemain--; cdRender(); if(cdRemain<=0){ clearInterval(cdTimer); } } },1000); cdRender(); };
    document.getElementById('cd-pause').onclick=()=>{ cdPaused=true; };
    document.getElementById('cd-resume').onclick=()=>{ cdPaused=false; };
    document.getElementById('cd-reset').onclick=()=>{ clearInterval(cdTimer); const m=Math.max(0,parseInt(document.getElementById('cd-min').value||'0',10)); const s=Math.max(0,parseInt(document.getElementById('cd-sec').value||'0',10)); cdRemain=m*60+s; cdPaused=false; cdRender(); };
    cdRender();

    // ===== Namen & Gruppen =====
    function getNames(){ return document.getElementById('nameList').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); }
    document.getElementById('ng-pick').onclick=()=>{ const list=getNames(); if(!list.length){ alert('Keine Namen eingegeben.'); return; } const name=list[Math.floor(Math.random()*list.length)]; document.getElementById('pickedName').textContent='Gew√§hlt: '+name; };
    document.getElementById('ng-reset').onclick=()=>{ document.getElementById('pickedName').textContent='‚Äî'; };
    function parsePairs(){ return document.getElementById('avoidPairs').value.split(/\r?\n/).map(l=>l.trim()).filter(Boolean).map(l=>l.split(',').map(s=>s.trim())).filter(p=>p.length===2); }
    function makeConflictFreeGroups(list, size, pairs){
      // place solo first as singletons
      const solo = document.getElementById('soloList').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const remaining = list.filter(n=>!solo.includes(n));
      const groups = solo.map(s=>[s]);
      // random fill remaining groups of given size
      const pool=[...remaining]; pool.sort(()=>Math.random()-0.5);
      while(pool.length){ groups.push(pool.splice(0,size)); }
      // check & simple repair
      function violates(g){ return pairs.some(([a,b])=>g.includes(a)&&g.includes(b)); }
      for(let tries=0; tries<500; tries++){
        let ok=true; for(const g of groups){ if(violates(g)){ ok=false; break; } }
        if(ok) return groups;
        // try swaps across groups
        for(let i=0;i<groups.length;i++){
          for(let j=i+1;j<groups.length;j++){
            for(let a=0;a<groups[i].length;a++){
              for(let b=0;b<groups[j].length;b++){
                const gi=[...groups[i]], gj=[...groups[j]];
                [gi[a],gj[b]]=[gj[b],gi[a]];
                if(!violates(gi) && !violates(gj)){ groups[i]=gi; groups[j]=gj; }
              }
            }
          }
        }
      }
      return groups;
    }
    document.getElementById('makeGroups').onclick=()=>{
      const list=getNames(); const size=Math.max(1, parseInt(document.getElementById('groupSize').value||'1',10)); if(!list.length){ alert('Bitte Namen eingeben.'); return; }
      const pairs=parsePairs(); const gs=makeConflictFreeGroups(list, size, pairs);
      document.getElementById('groups').innerHTML = gs.map((g,i)=>`<div class="hint" style="margin:6px 0"><b>Gruppe ${i+1}</b><br>${g.join(', ')}</div>`).join('');
    };

    // ===== L√ºckentext =====
    let czState=null, czShow=false;
    function czTokenize(t){ return t.match(/[A-Za-z√Ñ√ñ√ú√§√∂√º√ü√Ä-√ñ√ò-√∂√∏-√ø]+|\s+|[^\sA-Za-z√Ñ√ñ√ú√§√∂√º√ü√Ä-√ñ√ò-√∂√∏-√ø]/g)||[]; }
    document.getElementById('cz-make').onclick=()=>{
      const text=document.getElementById('cz-input').value; if(!text.trim()){ alert('Bitte Text eingeben.'); return; }
      const pct=Math.max(0,Math.min(90,parseInt(document.getElementById('cz-pct').value||'20',10)));
      const minlen=Math.max(2,parseInt(document.getElementById('cz-minlen').value||'4',10));
      const toks=czTokenize(text); const idx=[]; toks.forEach((t,i)=>{ if(/^[A-Za-z√Ñ√ñ√ú√§√∂√º√ü√Ä-√ñ√ò-√∂√∏-√ø]+$/.test(t) && t.length>=minlen) idx.push(i); });
      idx.sort(()=>Math.random()-0.5); const blanks=Math.floor(idx.length*pct/100); const chosen=new Set(idx.slice(0,blanks));
      const key=[]; const ws=toks.map((t,i)=>{ if(chosen.has(i)){ key.push(t); return '_'.repeat(Math.max(4, Math.min(t.length+1, 28))); } return t; }).join('');
      czState={ws, key}; renderCloze();
    };
    function renderCloze(){ const box=document.getElementById('cz-out'); if(!czState){ box.textContent=''; return; } box.innerHTML=`<div style="white-space:pre-wrap; line-height:1.8">${czState.ws.replace(/&/g,'&amp;').replace(/</g,'&lt;')}</div>` + (czShow? `<hr><div class="small"><b>L√∂sung:</b> ${czState.key.join(' / ')}</div>` : ''); }
    document.getElementById('cz-key').onclick=()=>{ czShow=!czShow; renderCloze(); };
    document.getElementById('cz-print').onclick=()=>{ const w=window.open('','print'); const html=`<pre style="font-family:system-ui,Arial;white-space:pre-wrap;line-height:2.0">${czState?czState.ws.replace(/&/g,'&amp;').replace(/</g,'&lt;'):''}</pre>`; w.document.write(html); w.document.close(); w.focus(); w.print(); w.close(); };

    // ===== Satzglied‚ÄëTester =====
    function parseSatzglieder(){
      const raw=document.getElementById('sg-input').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      return raw.map(line=> line.split('|').map(chunk=>{ const [seg,label]=chunk.split('~').map(s=>s.trim()); return {seg,label}; }));
    }
    function selectedTags(){ return Array.from(document.querySelectorAll('.sg-tag:checked')).map(el=>el.value); }
    let sgDeck=[], sgIdx=0, sgResults=[];
    function sgStart(){
      const all=parseSatzglieder(); const tags=new Set(selectedTags());
      sgDeck = all.filter(sentence => sentence.every(c=> tags.has(c.label)));
      if(!sgDeck.length){ alert('Keine S√§tze entsprechen der Auswahl.'); return; }
      sgIdx=0; sgResults=[]; document.getElementById('sg-summary').style.display='none'; document.getElementById('sg-quiz').style.display='block'; renderSgCard();
    }
    function renderSgCard(){
      const sent=sgDeck[sgIdx]; const host=document.getElementById('sg-quiz');
      const options = selectedTags();
      const rows = sent.map((c,i)=>{
        const opts = ['','...'].concat(options).map(o=>`<option value="${o}">${o||'‚Äî'}</option>`).join('');
        return `<div class="row" style="margin:4px 0"><div class="hint" style="flex:1">${c.seg}</div><select data-i="${i}">${opts}</select></div>`;
      }).join('');
      host.innerHTML = `<div class="hint"><div class="small">Aufgabe ${sgIdx+1} von ${sgDeck.length}</div></div>${rows}<div class="row" style="justify-content:flex-end;margin-top:8px"><button class="btn" id="sg-back" ${sgIdx?'' : 'disabled'}>Zur√ºck</button><button class="btn primary" id="sg-check">Pr√ºfen</button>${sgIdx<sgDeck.length-1?'' : '<button class="btn" id="sg-finish">Beenden</button>'}</div><div id="sg-fb" style="margin-top:8px"></div>`;
      document.getElementById('sg-back').onclick=()=>{ if(sgIdx>0){ sgIdx--; renderSgCard(); } };
      document.getElementById('sg-check').onclick=checkSg;
      const fin=document.getElementById('sg-finish'); if(fin) fin.onclick=sgFinish;
    }
    function checkSg(){
      const sent=sgDeck[sgIdx]; const selects=[...document.querySelectorAll('#sg-quiz select')];
      let correct=true; const feedback=[]; selects.forEach((sel,i)=>{ const user=sel.value; const ok = user===sent[i].label; feedback.push(`${sent[i].seg}: ${ok?'‚úì':'‚úó'} (${sent[i].label})`); if(!ok) correct=false; });
      sgResults[sgIdx]={correct};
      const fb=document.getElementById('sg-fb'); fb.innerHTML = '<div class="hint">'+feedback.map(esc).join('<br>')+'</div>';
      if(sgIdx<sgDeck.length-1){ const btn=document.createElement('button'); btn.className='btn'; btn.textContent='Weiter'; btn.style.marginTop='6px'; btn.onclick=()=>{ sgIdx++; renderSgCard(); }; fb.appendChild(btn); }
    }
    function sgFinish(){ const solved=sgResults.filter(r=>r&&r.correct).length; const total=sgDeck.length; const pct=Math.round(solved/total*100); const sum=document.getElementById('sg-summary'); sum.innerHTML=`<div class="hint"><b>Ergebnis:</b> ${solved}/${total} (${pct}%)</div>`; sum.style.display='block'; document.getElementById('sg-quiz').style.display='none'; }
    document.getElementById('sg-start').onclick=sgStart;

    // ===== Diktat =====
    let dkTimer=null; document.getElementById('dk-start').onclick=()=>{ const t=document.getElementById('dictInput').value.trim(); if(!t){ alert('Bitte Text eingeben.'); return; } const w=t.split(/\s+/); let i=0; clearInterval(dkTimer); document.getElementById('dictationDisplay').textContent=''; dkTimer=setInterval(()=>{ if(i>=w.length){ clearInterval(dkTimer); return; } document.getElementById('dictationDisplay').textContent += w[i++]+' '; }, 800); };
    document.getElementById('dk-stop').onclick=()=>{ clearInterval(dkTimer); };

    // ===== Text‚ÄëAnalyse =====
    function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;'); }
    function tokenizeWords(t){ return (t.match(/\b[\p{L}‚Äô']+[\p{L}‚Äô']*\b/gu)||[]); }
    function sentencesWithIndex(t){ const lines=t.split(/\r?\n/); const out=[]; let lineNo=0; for(let i=0;i<lines.length;i++){ const parts=lines[i].split(/(?<=[.!?])\s+/); for(const p of parts){ if(p.trim()) out.push({text:p.trim(), line:i+1}); } } return out; }
    const colloqList = ['voll','mega','krass','geil','echt','halt','saucool','ur','superduper','nice','lol','ey','boah'];
    document.getElementById('ta-run').onclick=()=>{
      const t=document.getElementById('analysisInput').value; if(!t.trim()){ alert('Bitte Text eingeben.'); return; }
      const words=tokenizeWords(t); const chars=t.replace(/\s/g,'').length; const sents=sentencesWithIndex(t);
      document.getElementById('ta-words').textContent=words.length; document.getElementById('ta-chars').textContent=chars; document.getElementById('ta-sent').textContent=sents.length;
      // Direct speech: capture ‚Äû‚Ä¶‚Äú ¬ª‚Ä¶¬´ "‚Ä¶"
      const quotes=[]; const re=/[‚Äû¬ª"\u201E\u00BB]([^"‚Äú¬´\u00AB‚Äû¬ª]+)[‚Äú¬´"\u201C\u00AB]/g; let m; while((m=re.exec(t))){ const frag=m[1]; // find containing sentence & line
        const entry = sents.find(s=> s.text.includes(frag)); if(entry) quotes.push({quote:frag, line:entry.line, sentence:entry.text}); }
      document.getElementById('ta-quotes').innerHTML = quotes.length? quotes.slice(0,12).map(q=>`<div class=\"hint\" style=\"margin:4px 0\"><div>‚Äû${esc(q.quote)}‚Äú</div><div class=\"small\">Zeile ${q.line}: ${esc(q.sentence)}</div></div>`).join('') : '<span class=\"small muted\">‚Äî</span>';
      // Colloquial flags & objective score (heuristic)
      const lower=words.map(w=>w.toLowerCase()); const flagged=[]; for(const w of lower){ if(colloqList.includes(w)) flagged.push(w); }
      const excl = (t.match(/!/g)||[]).length; const objective = Math.max(0, 100 - Math.min(100, flagged.length*5 + excl*3));
      document.getElementById('ta-objective').textContent = objective.toFixed(0)+"%";
      if(flagged.length){ const uniq=[...new Set(flagged)]; document.getElementById('ta-colloq').innerHTML = uniq.map(w=>`<span class=\"pill\" style=\"margin:2px;display:inline-block\">${w}</span>`).join(''); } else { document.getElementById('ta-colloq').innerHTML = '<span class=\"small muted\">Keine auff√§lligen W√∂rter gefunden.</span>'; }
      // Top words
      const stop=new Set(['der','die','das','und','oder','zu','in','den','des','dem','ein','eine','einer','mit','auf','f√ºr','ist','sind','war','waren','wie','ich','du','er','sie','es','wir','ihr','man','nicht','auch','aber','noch','am','im','an','vom','beim','um','so','nur','wenn','weil','dass','da√ü','als']);
      const freq={}; lower.forEach(w=>{ if(stop.has(w)) return; freq[w]=(freq[w]||0)+1; });
      const top=Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,12).map(([w,c])=>`${w} (${c})`).join(', ');
      document.getElementById('ta-top').textContent = top || '‚Äî';
    };
  </script>
</body>
</html>
